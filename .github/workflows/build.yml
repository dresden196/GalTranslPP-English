name: Build GalTransl++

on:
  push:
    branches: [ master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  QT_VERSION: '6.9.2'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup Visual Studio Dev Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2022_64'
        modules: 'qtwebsockets qtwebchannel'
        cache: true

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        runVcpkgInstall: true

    - name: Integrate vcpkg with MSBuild
      run: |
        ${{ env.VCPKG_ROOT }}\vcpkg integrate install
      shell: cmd

    - name: Download Qt VS Tools MSBuild files
      run: |
        # Download QtMsBuild files from Qt VS Tools repository
        $qtMsBuildUrl = "https://github.com/qt-labs/vstools/releases/download/v3.3.0/QtMsBuild.zip"
        Invoke-WebRequest -Uri $qtMsBuildUrl -OutFile QtMsBuild.zip

        # Extract to each project directory that needs it
        Expand-Archive -Path QtMsBuild.zip -DestinationPath GPPGUI -Force
        Expand-Archive -Path QtMsBuild.zip -DestinationPath Updater -Force

        # Create Qt version config for MSBuild
        $qtPath = "${{ env.Qt6_DIR }}"
        $qtVersionContent = @"
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Qt_INCLUDEPATH_>$qtPath\include</Qt_INCLUDEPATH_>
    <Qt_LIBPATH_>$qtPath\lib</Qt_LIBPATH_>
    <Qt_BINPATH_>$qtPath\bin</Qt_BINPATH_>
    <QtToolsPath>$qtPath\bin</QtToolsPath>
    <QtDllPath>$qtPath\bin</QtDllPath>
    <QTDIR>$qtPath</QTDIR>
  </PropertyGroup>
</Project>
"@
        # Create qt.conf in QtMsBuild folders
        $qtConfContent = @"
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <QtInstall>$qtPath</QtInstall>
    <QtInstallDir>$qtPath</QtInstallDir>
  </PropertyGroup>
</Project>
"@
        Set-Content -Path "GPPGUI\QtMsBuild\Qt_6.9.2_msvc2022_64_.props" -Value $qtVersionContent
        Set-Content -Path "Updater\QtMsBuild\Qt_6.9.2_msvc2022_64_.props" -Value $qtVersionContent
      shell: pwsh

    - name: Create lib directory
      run: mkdir -p lib
      shell: bash

    - name: Extract Python headers
      run: |
        if (Test-Path "GalTranslPP/Python.zip") {
          Expand-Archive -Path "GalTranslPP/Python.zip" -DestinationPath "." -Force
        }
      shell: pwsh

    - name: Build ElaWidgetTools
      run: |
        cd 3rdParty/ElaWidgetTools
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DQT_SDK_DIR="${{ env.Qt6_DIR }}"
        cmake --build build --config Release
        cp build/ElaWidgetTools/Release/ElaWidgetTools.lib ../../lib/
      shell: bash

    - name: Build OpenCC
      run: |
        cd 3rdParty/OpenCC
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=out/install/x64-Release
        cmake --build build --config Release
        cmake --install build --config Release
        cp out/install/x64-Release/lib/marisa.lib ../../lib/
        cp out/install/x64-Release/lib/opencc.lib ../../lib/
      shell: bash

    - name: Build GalTranslPP
      run: |
        msbuild GalTranslPP.slnx /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:QtInstall=${{ env.Qt6_DIR }} /p:QtToolsPath=${{ env.Qt6_DIR }}\bin
      env:
        QTDIR: ${{ env.Qt6_DIR }}

    - name: Prepare GPPGUI Release
      run: |
        mkdir -p release/GPPGUI
        cp Release/GPPGUI/GalTranslPP_GUI.exe release/GPPGUI/
        cp 3rdParty/OpenCC/out/install/x64-Release/bin/opencc.dll release/GPPGUI/
        cp 3rdParty/ElaWidgetTools/build/ElaWidgetTools/Release/ElaWidgetTools.dll release/GPPGUI/
        cp -r Example/BaseConfig release/GPPGUI/
        mkdir -p release/GPPGUI/Projects
        cp -r Example/sampleProject release/GPPGUI/Projects/
        windeployqt release/GPPGUI/GalTranslPP_GUI.exe
      shell: bash

    - name: Prepare GPPCLI Release
      run: |
        mkdir -p release/GPPCLI
        cp Release/GPPCLI/GalTranslPP_CLI.exe release/GPPCLI/
        cp 3rdParty/OpenCC/out/install/x64-Release/bin/opencc.dll release/GPPCLI/
        cp -r Example/BaseConfig release/GPPCLI/
        cp -r Example/sampleProject release/GPPCLI/
      shell: bash

    - name: Extract Python Embed for Release
      run: |
        if (Test-Path "Example/BaseConfig/python-3.12.10-embed-amd64.zip") {
          Expand-Archive -Path "Example/BaseConfig/python-3.12.10-embed-amd64.zip" -DestinationPath "release/GPPGUI/BaseConfig/python-3.12.10-embed-amd64" -Force
          Expand-Archive -Path "Example/BaseConfig/python-3.12.10-embed-amd64.zip" -DestinationPath "release/GPPCLI/BaseConfig/python-3.12.10-embed-amd64" -Force
        }
      shell: pwsh

    - name: Upload GPPGUI Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GalTranslPP-GUI-English
        path: release/GPPGUI/

    - name: Upload GPPCLI Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GalTranslPP-CLI-English
        path: release/GPPCLI/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download GUI Artifact
      uses: actions/download-artifact@v4
      with:
        name: GalTranslPP-GUI-English
        path: GalTranslPP-GUI-English

    - name: Download CLI Artifact
      uses: actions/download-artifact@v4
      with:
        name: GalTranslPP-CLI-English
        path: GalTranslPP-CLI-English

    - name: Create Archives
      run: |
        cd GalTranslPP-GUI-English && zip -r ../GalTranslPP-GUI-English.zip . && cd ..
        cd GalTranslPP-CLI-English && zip -r ../GalTranslPP-CLI-English.zip . && cd ..

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          GalTranslPP-GUI-English.zip
          GalTranslPP-CLI-English.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
